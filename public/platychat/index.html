<!DOCTYPE html>
<html>
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <title>Platychat&#128540;</title>
      <style>
         *{
            margin:0;
            padding:0;
            border:0;
            box-sizing:border-box;
         }
         
         #login,#menu,#messages{display:none;}
         
         /*Login*/
         
         #formLogin{
            display:flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
         }
         
         #formLogin > *{
            width:30%;
            margin: 5px;
            border-radius:1px;
            border:1px solid #eee;
            padding:10px;
            height: 30px;
         }
         
         #formLogin > h1{
            border: 0;
         }
         
         #formLogin > input:focus{
            outline:1px solid #aaa;
         }
         
         #formLogin > button{
            border-radius:5px;
            height:30px;
            background:#7703fc;
            color:#fff;
         }
         
         /*Menu*/
         
         #menu{
            flex-direction: column;
            justify-content: center;
            align-items: flex-start;
            height:100vh;
         }
         
         #menuConvosWrapper{
            height:80%;
            width:100%;
            overflow-y:scroll;
         }
         
         #menuConvos{
            font-family:verdana,arial;
            font-size:11px;
            color:#333;
            border-width:1px;
            border-color:#999;
            border-collapse:collapse;
            width:100%;
         }
         
         #menuConvos th{
            background:#7703fc;
            color:#fff;
            border: 1px solid #a9c6c9;
            padding: 8px;
            border-radius-top:12px;
         }
         
         #menuConvos td{
            background:#eee;
            color:#000;
            border: 1px solid #a9c6c9;
            padding: 8px;
         }
         
         #menuAddConvo,
         #menuOpenSettings,
         #menuLogout{
            background: #7703fc;
            color:#fff;
            width:100%;
            padding:8px;
         }
         
         #menuAddConvo,
         #menuLogout{
            border-bottom:5px solid black;
         }
         
         #menuOpenSettings{
            background:#777;
         }
         
         #menuCreateConvo{
            display:none;
            padding:10px;
            position:absolute;
            top:40%;
            left:40%;
            box-shadow: 0px 9px 40px -10px #333;
         }
         
         #menuCreateConvo form > input{
            border:1px solid black;
         }
         
         #menuCreateConvo form > button{
            border:1px solid black;
            background:#7703fc;
            color:#fff;
         }
         
         #menuSettings{
            display:none;
            padding:10px;
            position:absolute;
            top:30%;
            left:30%;
            background:#000;
            box-shadow: 0px 9px 40px -10px #333;
            z-index:100;
            width:300px;
         }
         
         #menuSettings *{
            margin:5px 0;
         }
         
         #menuSettings button{
            padding:2px;
            background: #7703fc;
            color: #fff;
            width:70px;
         }
         
         #menuSettings input{
            padding:2px;
         }
         
         #messageSearchResults{
            list-style-type:none;
            background:#fff;
            color:#000;
            height:200px;
            overflow-y:scroll;
         }
         
         /*Messenger*/
         
         #messenger{
            flex-direction:column;
            justify-content:center;
            align-items:center;
            height:90vh;
            width:100vw;
         }
         
         #messengerMessages{
            list-style-type: none; 
            margin: 0; 
            padding: 0;
            width:90%;
            height:80%;
            overflow-y:scroll;
         }
         
         #messengerMessages li {
            padding: 5px 10px;
         }
         
         #messengerMessages img{
            max-width:90%;
         }
         
         #messenger form{
            width:90%;
         }
         
         #messengerInput{
            border:1px solid black;
            width:90%;
            height:30px;
         }
         
         #messenger > form button{
            width:8%;
            height:30px;
            background: #7703fc;
            color: #fff;
         }
         
         #messengerCreateTag{
            display:none;
            padding:10px;
            position:absolute;
            top:40%;
            left:40%;
            background:#000;
            box-shadow: 0px 9px 40px -10px #333;
            z-index:100;
         }
         
         #messengerCreateTag form{
            display:flex;
            flex-direction:row;
         }
         
         #messengerCreateTag form > button{
            padding:2px;
            background: #7703fc;
            color: #fff;
            width:70px;
         }
         
         #messengerMenuBack {
            padding: 0 30px;
            height:30px;
            background: #7703fc;
            color: #fff;
         }
         
      </style>
   </head>
   <body>
   
      <section id = 'login'>
         <form id='formLogin'>
            <h1>Platychat</h1>
            <input id='username' autocomplete='off' placeholder='Username'>
            <input id='password' type='password' placeholder='Password'>
            <button>Login</button>
         </form>
      </section>
      
      
      <section id = 'menu'>
         
         <button id='menuOpenSettings'>&#x2699;Settings & Tools&#x2699;</button>
         
         <div id='menuCreateConvo'>
            <form>
               <p>Convo Name:</p><input type='text' autocomplete='off' id='menuConvoName'>
               <p>Participants:</p><input type='text' autocomplete='off' id='menuConvoParticipants'>
               <button>Create!</button>
            </form>
         </div>
         
         <div id = 'menuSettings'>
            <form id='menuSettingsSearch'>
               <input autocomplete='off'>
               <button>Search</button>
            </form>
            
            <ul id='messageSearchResults'>
            </ul>
            
            <button id='menuSettingsDarkmode'>Toggle</button>
            
            <ul id = 'menuSettingsUserTags'>
            </ul>
            
         </div>
         
         <div id='menuConvosWrapper'>
            <table id = 'menuConvos'>
               <tr>
                  <th>Convo ID</th>
                  <th>Convo Name</th>
                  <th>Participants</th>
               </tr>
            </table>
         </div>
         
         <button id='menuAddConvo'>&#10133;Add Convo&#10133;</button>
         <button id='menuLogout'>Logout</button>
         
      </section>
      
      <section id = 'messenger'>
         
         <div id='messengerMenu'>
            <button id='messengerMenuBack'>Back</button>
         </div>
         
         <ul id='messengerMessages'>
         </ul>
         
         <form>
            <input id='messengerInputFile' type='file'>
            <input id='messengerInput' autocomplete='off' type='text'>
            <button>Send</button>
         </form>
         
         <div id='messengerCreateTag'>
            <form>
               <input autocomplete='off'>
               <button>Tag</button>
            </form>
         </div>
      </section>
   </body>
   
   
   <script src='/socket.io/socket.io.js'></script>
   <script>
      var socket = io();
      
      //login elements
      var sectionLogin = document.querySelector('#login');
      var buttonLogin = document.querySelector('#formLogin > button');
      var inputUsername = document.querySelector('#username');
      var inputPassword = document.querySelector('#password');
      var formLogin = document.querySelector('#formLogin');
      
      //menu elements
      var sectionMenu = document.querySelector('#menu');
      var tableMenu = document.querySelector('#menuConvos');
      var buttonAddConvo = document.querySelector('#menuAddConvo'); 
      var buttonOpenSettings = document.querySelector('#menuOpenSettings');
      var buttonLogout = document.querySelector('#menuLogout');
      
      //menu create convo form
      var divCreateConvo = document.querySelector('#menuCreateConvo'); 
      var formCreateConvo = document.querySelector('#menuCreateConvo form'); 
      var inputConvoName = document.querySelector('#menuConvoName'); 
      var inputConvoParticipants = document.querySelector('#menuConvoParticipants'); 
      var buttonCreateConvo = document.querySelector('#menuCreateConvo form button'); 
      
      //menu settings popup
      var divSettings = document.querySelector('#menuSettings');
      var formSettingsSearch = document.querySelector('#menuSettingsSearch');
      var ulSettingsSearchResults = document.querySelector('#messageSearchResults');
      
      //messenger
      var sectionMessenger = document.querySelector('#messenger');
      var ulMessages = document.querySelector('#messengerMessages');
      var formMessenger = document.querySelector('#messenger form');
      var inputMessenger = document.querySelector('#messengerInput');
      var inputMessengerFile = document.querySelector('#messengerInputFile');
      var divMenuMessenger = document.querySelector('#messengerMenu');
      var buttonMessengerBack = document.querySelector('#messengerMenuBack');
      
      //messenger create tag form
      var divCreateTag = document.querySelector('#messengerCreateTag');
      var formCreateTag = document.querySelector('#messengerCreateTag form');
      var inputCreateTag = document.querySelector('#messengerCreateTag form input');
      var buttonCreateTag = document.querySelector('#messengerCreateTag form button');
      
      var PageData = {
         'states':['login','menu','menu-add-convo','messenger'],
         'currentState':''
      };
      
      (function init(){
         var sessionid = localStorage.getItem('platychat-sessionid');
         var userid = localStorage.getItem('platychat-userid');
         
         if(sessionid && userid){
            PageData.sessionid = sessionid;
            PageData.userid = userid;
            socket.emit('pre-login-request',sessionid, userid);
         }else{
            PageData.currentState = 'login';
         }
      })();
      
      (function main(){
         requestAnimationFrame(main);
         render();
      })();
      
      function render(){
         switch(PageData.currentState){
            case 'login':
               sectionLogin.style.display = 'block';
               sectionMenu.style.display = 'none';
               sectionMessenger.style.display = 'none';
               break;
            case 'menu':
               sectionLogin.style.display = 'none';
               sectionMenu.style.display = 'flex';
               sectionMessenger.style.display = 'none';
               break;
            case 'messenger':
               sectionLogin.style.display = 'none';
               sectionMenu.style.display = 'none';
               sectionMessenger.style.display = 'flex';
               break;
            default:
               sectionLogin.style.display = 'none';
               sectionMenu.style.display = 'none';
               sectionMessenger.style.display = 'none';
         }
      }
      
      /*
      *
      *element listeners
      *element listeners
      *element listeners
      *
      */
      
      window.addEventListener('paste',function(e){
         var items = e.clipboardData.items;
         var blob;
         
         for(var i = 0; i<items.length; i++){
            if(items[i].kind === 'file'){
               blob = items[i].getAsFile();
               break;
            }
         }
         
         if(typeof blob === 'undefined') return;
         
         var fileReader = new FileReader();
         fileReader.onload = function(e){
            inputMessenger.value = '/image ' + e.target.result;
         }
         fileReader.readAsDataURL(blob);
      });
      
      inputMessengerFile.addEventListener('change',function(e){
         var fileList = this.files;
         
         for(var i = 0; i < fileList.length; i++){
            var blob = fileList[i];
            
            var fileReader = new FileReader();
            fileReader.onload = function(e){
               inputMessenger.value = '/image ' + e.target.result;
            }
            fileReader.readAsDataURL(blob);
         }
         
      });
      
      formLogin.addEventListener('submit',function(e){
         e.preventDefault();
         var username = inputUsername.value;
         var password = inputPassword.value;
         if(username.length <= 0 || password.length <= 0) return console.error('Inputs invalid');
         socket.emit('login-request',username,password);
         inputUsername.value = '';
         inputPassword.value = '';
      });
      
      formCreateConvo.addEventListener('submit',function(e){
         e.preventDefault();
      });
      
      formCreateTag.addEventListener('submit',function(e){
         e.preventDefault();
         socket.emit('message-tag-request',PageData.sessionid, PageData.userid, PageData.selectedMessageid, inputCreateTag.value);
         
         inputCreateTag.value = '';
         
         hideCreateTagForm();
      });
      
      formMessenger.addEventListener('submit',function(e){
         e.preventDefault();
         
         if(inputMessenger.value.length <= 0) return console.error('cant submit blank');
         
         socket.emit('convo-message-request',PageData.sessionid, PageData.userid, PageData.currentConvoId, inputMessenger.value);
         
         inputMessenger.value = '';
      });
      
      formSettingsSearch.addEventListener('submit',function(e){
         e.preventDefault();
         
         var inputSettingsSearch = document.querySelector('#menuSettings form input');
         
         if(inputSettingsSearch.value.length <= 0) return console.error('cant submit blank');
         
         socket.emit('convo-search-request',PageData.sessionid,PageData.userid, inputSettingsSearch.value);
         
         inputSettingsSearch.value = '';
      });
      
      buttonOpenSettings.addEventListener('click',function(e){
         e.preventDefault();
         e.stopPropagation();
         divSettings.style.display = 'block';
      });
      
      buttonMessengerBack.addEventListener('click',function(e){
         e.preventDefault();
         e.stopPropagation();
         
         ulMessages.innerHTML = '';
         
         PageData.currentState = 'menu';
      });
      
      buttonLogout.addEventListener('click',function(e){
         e.preventDefault();
         e.stopPropagation();
         localStorage.clear();
         location.reload();
      });
      
      function showCreateTagForm(e){
         e.stopPropagation();
         e.preventDefault();
         
         divCreateTag.style.display = 'block';
         divCreateTag.style.top = e.clientY + 'px';
         divCreateTag.style.left  = e.clientX + 'px';
         
         var messageid = /[0-9]+/.exec(this.parentNode.id)[0];
         
         PageData.selectedMessageid = messageid;
      }
      
      function hideCreateTagForm(e){
         divCreateTag.style.display = 'none';
         divSettings.style.display = 'none';
      }
      
      window.addEventListener('click',function(e){
         e.stopPropagation();
         if(
            e.target == divCreateTag
            || e.target == formCreateTag
            || e.target == inputCreateTag
            || e.target == divSettings
            || Array.from(formSettingsSearch.childNodes).indexOf(e.target) != -1
         ) return;
         hideCreateTagForm();
      });
      
      
      /*
      *
      *socket response handlers
      *socket response handlers
      *socket response handlers
      *
      */
      
      socket.on('login-response',function(sessionid,userid){
         if(/ERROR/.test(sessionid)){
            console.error(sessionid);
            PageData.currentState = 'login';
            return localStorage.clear();
         }
         if(typeof userid === 'undefined'){
            console.error('user not defined') 
            PageData.currentState = 'login';
            return localStorage.clear();
         } 
         
         PageData.sessionid = sessionid;
         PageData.userid = userid;
         localStorage.setItem('platychat-sessionid',sessionid);
         localStorage.setItem('platychat-userid',userid);
         
         socket.emit('convo-list-request',PageData.sessionid, PageData.userid);
      });
      
      socket.on('pre-login-response',function(sessionid){
         if(sessionid === PageData.sessionid) {
            socket.emit('convo-list-request',PageData.sessionid, PageData.userid);
         }
         else {
            console.error(sessionid);
            PageData.currentState = 'login';
            localStorage.clear();
         }
      });
      
      socket.on('convo-list-response',function(convoList){
         if(convoList <= 0) return console.error('no conversations!');
         convoList = JSON.parse(convoList);
         
         PageData.convoList = convoList;
         
         PageData.currentState = 'menu';
         
         convoList.forEach(function(d){
            var elt = document.createElement('tr');
            elt.id = 'convo-' + d.convoid;
            elt.innerHTML = '<td>' + d.convoid + '</td>'
            + '<td>' + d.convoname + '</td>'
            + '<td>' + d.participants + '</td>'
            
            elt.addEventListener('click',function(e){
               e.stopPropagation();
               var convoid = elt.querySelector('td:first-child').innerHTML;
               socket.emit('convo-join-request',PageData.sessionid, PageData.userid, convoid);
            });
            
            tableMenu.append(elt);
         });
      });
      
      socket.on('convo-join-response',function(convoid,messages){
         if(/ERROR/.test(PageData.sessionid)) return console.error(PageData.sessionid) && (PageData.currentState = 'menu');
         if(typeof convoid === 'undefined') return console.error('no convoid') && (PageData.currentState = 'menu');
         
         PageData.currentState = 'messenger'
         PageData.currentConvoId = convoid;
         
         messages = JSON.parse(messages);
         
         messages.forEach(function(d){
            var elt = document.createElement('li');
            elt.id = 'message-' + d.messageid;
            elt.innerHTML = 
               '<span style="color:' + d.color + '">' + d.alias + '</span>' 
               + (d.tagname === null ? '' : '(' + d.tagname + ')') + ': ' + d.rawtext;
            
            var span = elt.querySelector('span');
            
            span.addEventListener('click',showCreateTagForm);
            
            ulMessages.append(elt);
         });
         
         setTimeout(function(){
            ulMessages.scrollTo(0,100000000);
         },100);
         
         //imageReplacement();
      });
      
      socket.on('convo-message-response',function(convoid){});
      
      socket.on('convo-message-incoming',function(convoid,messageid,alias,color,rawtext){
         var elt = document.createElement('li');
         elt.id = 'message-' + messageid;
         elt.innerHTML = '<span style="color:' + color + '">' + alias + '</span>' + ': ' + rawtext;
         
         var span = elt.querySelector('span');
         span.addEventListener('click',showCreateTagForm);
         
         ulMessages.append(elt);
         ulMessages.scrollTo(0,100000000);
      });
      
      socket.on('convo-search-response',function(messages){
         messages = JSON.parse(messages);
         
         ulSettingsSearchResults.innerHTML = '';
         
         messages.forEach(function(d){
            var elt = document.createElement('li');
            
            elt.innerHTML = (d.tagname !== null && d.tagname.length > 0 ? d.tagname + ' --- ' : '') + d.alias + ': ' + d.rawtext;
            
            ulSettingsSearchResults.append(elt);
         });
      });
      
      socket.on('message-tag-response',function(messageid,tagname,alias,color,rawtext){
         var messageElt = document.querySelector('#message-' + messageid);
         messageElt.innerHTML = 
               '<span style="color:' + color + '">' + alias + '</span>' 
               + (tagname === null ? '' : '(' + tagname + ')') + ': ' + rawtext;
      });
      
   </script>
</html>